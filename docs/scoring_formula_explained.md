# 🎯 품목 점수 계산 공식 상세 설명

## 📊 전체 구조

```
최종 점수 (Final Score) = 기본 점수 + 가중치 시스템 점수
```

---

## 1️⃣ 기본 점수 (Base Score) 계산

### 📝 기본 점수란?
- **문자열 유사도** 기반 점수
- 입력한 품목명과 데이터베이스 품목명이 얼마나 비슷한지 측정
- **0.0 ~ 1.0** 범위

### 🔍 계산 방법

#### **Step 1: 영문 단어 매칭 우선 (영어 단어가 3글자 이상 2개 이상 있을 때)**

```typescript
입력: "Lake Chalice Marlborough Sauvignon Blanc"
품목: "Lake Chalice Estate Reserve Sauvignon Blanc"

1. 영문 단어 추출:
   입력 단어: [lake, chalice, marlborough, sauvignon, blanc]  (5개)
   품목 단어: [lake, chalice, estate, reserve, sauvignon, blanc]  (6개)

2. 교집합 계산:
   공통 단어: [lake, chalice, sauvignon, blanc]  (4개)

3. 점수 계산:
   ✅ 3개 이상 매칭 → Recall/Precision 기반
   
   Recall = 4 / 5 = 0.80      (입력 단어 중 매칭 비율)
   Precision = 4 / 6 = 0.67   (품목 단어 중 매칭 비율)
   
   기본 점수 = (0.80 + 0.67) / 2 + 0.2 = 0.735 + 0.2 = 0.935
   최종 = min(0.95, 0.935) = 0.935
```

```typescript
✅ 3개 이상 매칭:
   score = min(0.95, (recall + precision) / 2 + 0.2)
   
⚠️ 2개 매칭:
   score = min(0.85, recall + 0.3)
   
❌ 1개 이하:
   한글 정규화 로직으로 전환
```

#### **Step 2: 한글 정규화 로직 (영문 매칭 실패 시)**

```typescript
입력: "샤또 마고 24병"
품목: "샤또 마고"

1. 정규화 (공백/특수문자 제거, 소문자 변환):
   norm("샤또 마고") = "샤또마고"
   norm("샤또 마고") = "샤또마고"

2. 완전 일치 검사:
   "샤또마고" == "샤또마고" ✅
   → 점수 = 1.0

3. 부분 일치 검사:
   "샤또마고".includes("샤또") ✅
   → 점수 = 0.9

4. 공통 문자 비율:
   공통 문자 수 / max(6, 입력 길이)
   → 점수 = min(0.89, 비율)
```

**정규화 규칙:**
```
- 공백 제거
- 괄호, 하이픈, 언더스코어, 슬래시, 점 제거
- 소문자 변환
```

---

## 2️⃣ 가중치 시스템 (Weighted Scoring System)

### 🎯 5가지 신호 (Signals)

```
최종 점수 = (기본 점수 × 1.0) + 
           (사용자 학습 × 3.0) + 
           (최근 구매 × 2.0) + 
           (구매 빈도 × 1.5) + 
           (빈티지 × 1.0)
```

---

### 🧠 신호 1: 사용자 학습 (User Learning)

**가장 강력한 신호 (가중치 3.0배)**

#### 📋 학습 매칭 종류

| 매칭 종류 | 조건 | 보너스 | 가중치 적용 | 최종 점수 |
|---------|------|--------|------------|----------|
| **Exact** | 입력과 학습 별칭이 완전 일치 | 0.20~0.40 | × 3.0 | **0.60~1.20** |
| **Contains Specific** | 입력에 구체적 별칭 포함 | 0.20~0.40 | × 3.0 | **0.60~1.20** |
| **Contains Weak** | 입력에 약한 별칭 포함 | 0.10~0.20 | × 3.0 | **0.30~0.60** |

#### 🔢 학습 횟수별 보너스

```
1회 학습 → 0.20 점
2회 학습 → 0.30 점
3회+ 학습 → 0.40 점
```

#### ✅ 구체적 별칭 (Specific Alias) 판단 기준

```typescript
function isSpecificAlias(alias: string) {
  const tokens = alias.split(" ");
  const tightLen = 공백제거후길이(alias);
  
  return tokens.length >= 3  ||  tightLen >= 12;
}
```

**예시:**
- ✅ "찰스하이직 샤르도네" → Specific (3단어)
- ✅ "로쉬벨렌말보로" → Specific (12글자)
- ❌ "ch" → Weak (1단어, 2글자)
- ❌ "말보로" → Weak (1단어, 3글자)

#### 📊 실전 예시

```typescript
예시 1: 'ch' → '찰스하이직' 학습 3회
  입력: "ch 샤르도네"
  
  매칭: Contains Weak (단어 1개, 2글자)
  기본 보너스: 0.40 (3회 학습)
  약한 별칭 감소: 0.40 × 0.5 = 0.20
  가중치 적용: 0.20 × 3.0 = 0.60 점
  
예시 2: '찰스하이직 샤르도네' → '3A24401' 학습 3회
  입력: "찰스하이직 샤르도네 24병"
  
  매칭: Exact (완전 일치)
  기본 보너스: 0.40 (3회 학습)
  가중치 적용: 0.40 × 3.0 = 1.20 점
  → 즉시 확정! (score 1.0)
```

---

### 🛒 신호 2: 최근 구매 (Recent Purchase)

**가중치: 2.0배**

#### 📅 경과일수별 보너스

| 기간 | 보너스 | 가중치 적용 | 최종 점수 |
|------|--------|------------|----------|
| 최근 7일 | 0.20 | × 2.0 | **+0.40** |
| 최근 30일 | 0.15 | × 2.0 | **+0.30** |
| 최근 90일 | 0.10 | × 2.0 | **+0.20** |
| 90일 이상 | 0.05 | × 2.0 | **+0.10** |

#### 📊 실전 예시

```typescript
거래처: 01025
품목: 3A24401 (찰스하이직 샤르도네)
최근 출고일: 2026-01-05 (5일 전)

보너스: 0.20 (7일 이내)
가중치 적용: 0.20 × 2.0 = +0.40 점
```

---

### 📈 신호 3: 구매 빈도 (Purchase Frequency)

**가중치: 1.5배**

#### 🔢 구매 횟수별 보너스

| 구매 횟수 | 보너스 | 가중치 적용 | 최종 점수 |
|----------|--------|------------|----------|
| 10회 이상 (Very High) | 0.15 | × 1.5 | **+0.225** |
| 5~9회 (High) | 0.10 | × 1.5 | **+0.15** |
| 2~4회 (Medium) | 0.05 | × 1.5 | **+0.075** |
| 1회 (Low) | 0.02 | × 1.5 | **+0.03** |

#### 📊 실전 예시

```typescript
거래처: 01025
품목: 3A24401 (찰스하이직 샤르도네)
구매 이력: 12회

보너스: 0.15 (10회 이상)
가중치 적용: 0.15 × 1.5 = +0.225 점
```

---

### 🍷 신호 4: 빈티지 (Vintage)

**가중치: 1.0배**

#### 📅 빈티지 점수 계산

**Case 1: 입력에 빈티지 힌트 있음**

```typescript
입력: "샤또 마고 2019"
품목: 3A19123 (2019년 빈티지)

빈티지 매칭: 2019 == 2019 ✅
보너스: +0.08 × 1.0 = +0.08 점

빈티지 불일치: 2019 != 2020 ❌
보너스: -0.18 × 1.0 = -0.18 점
```

**Case 2: 입력에 빈티지 힌트 없음 (최신 우선)**

```typescript
현재 연도: 2026
품목 빈티지: 2026 → yearDiff = 0
  → 보너스 = 0.20 (최신!)

품목 빈티지: 2025 → yearDiff = 1
  → 보너스 = 0.15

품목 빈티지: 2024 → yearDiff = 2
  → 보너스 = 0.10

품목 빈티지: 2023 이전 → yearDiff >= 3
  → 보너스 = 0.05
```

#### 🔍 빈티지 추출 규칙

```typescript
품목 코드에서 추출:
  예: "3A24401" → 24 → 2024년

입력에서 추출:
  4자리: "2019" → 2019년
  2자리: "19" → 2019년 (50 이상이면 1900년대)
```

---

### 📊 신호 5: 기본 점수 (Base Score)

**가중치: 1.0배**

```typescript
기본 점수 = scoreItem(입력, 품목명)  // 0.0 ~ 1.0
가중치 적용 = 기본 점수 × 1.0
```

---

## 🎯 최종 점수 계산 예시

### 예시 1: 학습 없는 신규 검색

```typescript
입력: "샤또 마고 24병"
거래처: 01025
품목: 3A24401 (샤또 마고 2024)

1️⃣ 기본 점수:
   문자열 유사도 = 0.90
   가중치 적용: 0.90 × 1.0 = 0.90

2️⃣ 사용자 학습:
   학습 없음 = 0.00
   가중치 적용: 0.00 × 3.0 = 0.00

3️⃣ 최근 구매:
   5일 전 구매 = 0.20
   가중치 적용: 0.20 × 2.0 = 0.40

4️⃣ 구매 빈도:
   12회 구매 = 0.15
   가중치 적용: 0.15 × 1.5 = 0.225

5️⃣ 빈티지:
   2024년 (최신) = 0.20
   가중치 적용: 0.20 × 1.0 = 0.20

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
최종 점수 = 0.90 + 0.00 + 0.40 + 0.225 + 0.20
          = 1.725 점
```

### 예시 2: 학습 3회 후

```typescript
입력: "샤또 마고 24병"
거래처: 01025
품목: 3A24401 (샤또 마고 2024)
학습: "샤또 마고" → 3A24401 (3회)

1️⃣ 기본 점수:
   문자열 유사도 = 0.90
   가중치 적용: 0.90 × 1.0 = 0.90

2️⃣ 사용자 학습:
   3회 학습, Exact 매칭 = 0.40
   가중치 적용: 0.40 × 3.0 = 1.20  ⭐

3️⃣ 최근 구매:
   5일 전 구매 = 0.20
   가중치 적용: 0.20 × 2.0 = 0.40

4️⃣ 구매 빈도:
   12회 구매 = 0.15
   가중치 적용: 0.15 × 1.5 = 0.225

5️⃣ 빈티지:
   2024년 (최신) = 0.20
   가중치 적용: 0.20 × 1.0 = 0.20

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
최종 점수 = 0.90 + 1.20 + 0.40 + 0.225 + 0.20
          = 2.925 점  🚀

→ 학습 효과로 +1.20 점 상승!
→ 압도적 1위 확정!
```

### 예시 3: 약어 학습 ('ch')

```typescript
입력: "ch 샤르도네 24병"
거래처: 01025
품목: 3A24401 (찰스하이직 샤르도네 2024)
학습: "ch" → "찰스하이직" (3회)

1️⃣ 기본 점수:
   "ch 샤르도네" vs "찰스하이직 샤르도네"
   문자열 유사도 = 0.45 (낮음)
   가중치 적용: 0.45 × 1.0 = 0.45

2️⃣ 사용자 학습:
   3회 학습, Contains Weak 매칭
   = 0.40 × 0.5 = 0.20
   가중치 적용: 0.20 × 3.0 = 0.60  ⭐

3️⃣ 최근 구매:
   5일 전 구매 = 0.20
   가중치 적용: 0.20 × 2.0 = 0.40

4️⃣ 구매 빈도:
   12회 구매 = 0.15
   가중치 적용: 0.15 × 1.5 = 0.225

5️⃣ 빈티지:
   2024년 (최신) = 0.20
   가중치 적용: 0.20 × 1.0 = 0.20

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
최종 점수 = 0.45 + 0.60 + 0.40 + 0.225 + 0.20
          = 1.875 점  ✅

→ 약어 학습으로도 충분한 점수!
```

---

## 🎯 특수 규칙

### ⚡ 즉시 확정 규칙 (Hard Confirmation)

#### 1️⃣ Exact 학습 매칭

```typescript
if (learned.kind === "exact" && learnedItemNo) {
  return {
    score: 1.0,
    method: "alias_exact_item_no",
    resolved: true
  };
}
```

**예시:**
- 입력: "샤또 마고"
- 학습: "샤또 마고" → "3A24401"
- 결과: **즉시 확정! (score 1.0)**

#### 2️⃣ Contains Specific 학습 매칭

```typescript
if (learned.kind === "contains_specific" && learnedItemNo) {
  return {
    score: 0.99,
    method: "alias_contains_specific_item_no",
    resolved: true
  };
}
```

**예시:**
- 입력: "찰스하이직 샤르도네 24병"
- 학습: "찰스하이직 샤르도네" → "3A24401"
- 결과: **즉시 확정! (score 0.99)**

---

## 📊 점수 범위 요약

| 신호 | 가중치 | 최소 | 최대 | 실제 영향 |
|-----|--------|------|------|-----------|
| **기본 점수** | 1.0× | 0.00 | 1.00 | 0.00 ~ 1.00 |
| **사용자 학습** | 3.0× | 0.00 | 0.40 | **0.00 ~ 1.20** |
| **최근 구매** | 2.0× | 0.00 | 0.20 | 0.00 ~ 0.40 |
| **구매 빈도** | 1.5× | 0.00 | 0.15 | 0.00 ~ 0.225 |
| **빈티지** | 1.0× | -0.18 | 0.20 | -0.18 ~ 0.20 |
| **합계** | - | - | - | **-0.18 ~ 3.025** |

---

## 🎓 핵심 포인트

### ✨ 가장 중요한 3가지

1. **사용자 학습 (× 3.0)** 
   - 가장 강력한 신호
   - 3회 학습 시 +1.20점 추가
   - Exact 매칭 시 즉시 확정

2. **최근 구매 (× 2.0)**
   - 7일 이내 구매 시 +0.40점
   - 거래처 맞춤 정확도

3. **기본 점수 (× 1.0)**
   - 문자열 유사도 기반
   - 0.0 ~ 1.0 범위

### 📈 점수 누적 효과

```
학습 전: 1.725 점
     ↓
1회 학습: 2.325 점 (+0.60)
     ↓
3회 학습: 2.925 점 (+1.20)
     ↓
즉시 확정! ⭐
```

### 🚀 최적화 전략

1. **자주 주문하는 품목**: 3회 이상 학습
2. **약어 활용**: 생산자 약어로 빠른 입력
3. **정확한 품목명**: 학습 데이터 품질 향상

---

## 📝 관련 파일

- `/app/lib/weightedScoring.ts` - 가중치 시스템
- `/app/lib/resolveItemsWeighted.ts` - 메인 점수 계산
- `/app/lib/queryExpander.ts` - 검색어 확장 (토큰 매핑)
- `/app/lib/autoLearn.ts` - 자동 학습 시스템
