# 🎓 자동 학습 시스템 - 실제 작동 방식

## 📌 핵심: **당신이 발주 입력하고 품목 선택하면 자동으로 학습됩니다!**

---

## 🔄 실제 사용 시나리오

### 시나리오 1: 첫 번째 발주 (학습 데이터 0건)

```
당신: Wine Order 페이지에서 "ch 샤도네 24병" 입력
     ↓
시스템: 검색 결과 표시
  1. 찰스하이직 샤르도네 (점수 0.65)
  2. 샤또 샤르도네 (점수 0.58)
  3. ...
     ↓
당신: "찰스하이직 샤르도네" 선택 → 확정 버튼 클릭
     ↓
🎓 자동 학습 시작!
     ↓
시스템이 자동으로 분석:
  입력 토큰: ["ch", "샤도네"]
  선택된 품목: "찰스하이직 샤르도네"
  
  매핑 생성:
    ✅ "ch" → "찰스하이직" (생산자 약어 감지!)
    ✅ "샤도" → "샤르도네" (품종 약어 감지!)
     ↓
저장됨!
  1. token_mapping 테이블:
     - ch → 찰스하이직 (count: 1, confidence: 0.5)
     - 샤도 → 샤르도네 (count: 1, confidence: 0.5)
  
  2. ml_training_data 테이블:
     - query: "ch 샤도네 24병"
     - selected: "찰스하이직 샤르도네"
     - rejected: ["샤또 샤르도네", ...]
```

### 시나리오 2: 두 번째 발주 (학습 데이터 1건)

```
당신: 다시 "ch 샤르도네 24병" 입력
     ↓
시스템: 검색 시 자동 확장!
  원본: "ch 샤르도네"
  확장: "찰스하이직 샤르도네" (학습된 매핑 사용!)
     ↓
검색 결과:
  1. 찰스하이직 샤르도네 (점수 1.20!) ⭐ 압도적 1위!
  2. 샤또 샤르도네 (점수 0.58)
     ↓
당신: 1번이 확실히 1위니까 바로 선택
     ↓
🎓 다시 학습!
     ↓
업데이트:
  - ch → 찰스하이직 (count: 2, confidence: 0.6)
  - 샤도 → 샤르도네 (count: 2, confidence: 0.6)
  - ml_training_data: 2번째 데이터 추가
```

### 시나리오 3: 세 번째 발주 (학습 데이터 2건)

```
당신: "ch 샤도네" 입력 (24병 생략해도 OK)
     ↓
시스템: 
  확장: "찰스하이직 샤르도네"
  검색 결과:
    1. 찰스하이직 샤르도네 (점수 1.40!) ⭐⭐
     ↓
자동 확정! (점수 > 0.9이고 압도적 1위)
     ↓
당신: 확정만 클릭하면 끝!
     ↓
🎓 또 학습!
     ↓
업데이트:
  - ch → 찰스하이직 (count: 3, confidence: 0.7)
  - 샤도 → 샤르도네 (count: 3, confidence: 0.7)
  - ml_training_data: 3번째 데이터 추가
```

---

## 🧠 자동 학습이 감지하는 것들

### 1️⃣ 생산자 약어 감지

**영문 이니셜:**
```
입력: "ch" → 선택: "찰스하이직"
분석: ch = Charles Heidsieck 이니셜 ✅
학습: ch → 찰스하이직

입력: "lc" → 선택: "레이크 찰리스"
분석: lc = Lake Chalice 이니셜 ✅
학습: lc → 레이크 찰리스
```

**한글 초성:**
```
입력: "ㅊㅎㅈ" → 선택: "찰스하이직"
분석: ㅊ + ㅎ + ㅈ = 찰 + 스 + 하이직 초성 ✅
학습: ㅊㅎㅈ → 찰스하이직
```

**부분 매칭:**
```
입력: "찰스" → 선택: "찰스하이직 샤르도네"
분석: "찰스"가 "찰스하이직"에 포함 ✅
학습: 찰스 → 찰스하이직
```

### 2️⃣ 품종 약어 감지

**알려진 약어 매핑:**
```
샤르도네: 샤도, 샤도네, chard, chardonnay
까베르네소비뇽: 까베, 카베, cab, cs
피노누아: 피노, pinot, pn
말벡: 말벡, malbec
```

**실제 예시:**
```
입력: "ch 까베" → 선택: "찰스하이직 카베르네소비뇽"
학습:
  - ch → 찰스하이직 (생산자)
  - 까베 → 카베르네소비뇽 (품종)
```

### 3️⃣ ML 학습 데이터 수집

**저장되는 내용:**
```json
{
  "query": "ch 샤도네 24병",
  "query_normalized": "ch 샤도네",
  "selected_item_no": "3A24401",
  "selected_item_name": "찰스하이직 샤르도네",
  "rejected_items": ["3B56789", "3C12345"],
  "client_code": "01025",
  "features": {
    "recent_purchase": 0.4,
    "frequency": 0.225,
    "vintage": 0.2
  },
  "created_at": "2026-01-12 10:30:45"
}
```

**용도:**
- PyTorch Fine-tuning 데이터
- 정확도 분석 (어떤 케이스에서 틀렸는지)
- 패턴 발견 (자주 헷갈리는 품목)

---

## 📊 500건 수집까지 로드맵

### Week 1: 50건 (하루 10건)
```
예상 학습 내용:
  - 생산자 약어 10-15개
  - 품종 약어 5-8개
  - 기본 패턴 확립

효과:
  - 자주 쓰는 약어는 즉시 확장
  - 정확도 85% → 88%
```

### Week 2: 100건 누적
```
예상 학습 내용:
  - 생산자 약어 25-30개
  - 품종 약어 10-12개
  - 거래처별 선호 품목 파악

효과:
  - 대부분의 약어 학습 완료
  - 정확도 88% → 91%
```

### Week 3-4: 300건 누적
```
예상 학습 내용:
  - 생산자 약어 40-50개
  - 품종 약어 15-20개
  - 복잡한 패턴 학습

효과:
  - Rule-based만으로도 92% 달성
  - 대부분 자동 확정
```

### Month 2: 500건+ 달성
```
PyTorch 활성화 준비 완료!
  - 충분한 학습 데이터
  - Fine-tuning 가능
  - 정확도 95%+ 목표
```

---

## 🎯 학습 데이터 품질

### ✅ 좋은 학습 데이터

```
입력: "lc 말보로"
선택: "레이크 찰리스 말보로"
→ 명확한 약어 매핑 학습!

입력: "ch 샤도"
선택: "찰스하이직 샤르도네"
→ 생산자 + 품종 동시 학습!

입력: "로쉬벨렌 까베"
선택: "로쉬벨렌 카베르네소비뇽"
→ 품종 약어 학습!
```

### ⚠️ 노이즈 데이터 (자동 필터링)

```
입력: "와인"
선택: "아무 와인"
→ 너무 일반적 (학습 안 됨)

입력: "12345"
선택: "품목 12345"
→ 숫자만 (학습 안 됨)

입력: "ㅁㄴㅇㄹ"
선택: "무엇인가"
→ 의미 없음 (학습 안 됨)
```

---

## 🔍 학습 진행 상황 확인

### 방법 1: 데이터베이스 직접 확인

```bash
cd /home/user/webapp

# 토큰 매핑 확인
node -e "
const db = require('better-sqlite3')('./data.sqlite3');
const mappings = db.prepare('SELECT * FROM token_mapping ORDER BY learned_count DESC LIMIT 10').all();
console.table(mappings);
"

# ML 학습 데이터 확인
node -e "
const db = require('better-sqlite3')('./data.sqlite3');
const count = db.prepare('SELECT COUNT(*) as cnt FROM ml_training_data').get();
console.log('학습 데이터:', count.cnt, '건');
"
```

### 방법 2: 로그 확인

```bash
# PM2 로그에서 자동 학습 확인
pm2 logs order-ai --nostream | grep "AutoLearn"

# 예시 출력:
# [AutoLearn] 학습 시작: "ch 샤도네" → 3A24401
# [AutoLearn] 입력 토큰: ["ch","샤도네"]
# [AutoLearn] 키워드: producer="찰스하이직", varietal="샤르도네"
# [AutoLearn] 토큰 매핑: "ch" → "찰스하이직" (producer, count: 3)
# [AutoLearn] 토큰 매핑: "샤도" → "샤르도네" (varietal, count: 2)
# [AutoLearn] 매핑 생성: 2개
```

### 방법 3: Wine Order 페이지 학습 탭

```
Wine Order 페이지 → "학습" 탭
  - 학습된 별칭 목록 표시
  - 토큰 매핑 표시
  - 학습 횟수 표시
```

---

## 🚀 학습 가속화 팁

### Tip 1: 약어를 적극 사용하세요!

```
❌ 나쁜 예: "찰스하이직 샤르도네 24병"
→ 정확하지만 학습 효과 없음

✅ 좋은 예: "ch 샤도 24병"
→ 약어 학습 + 확장 검색 연습
```

### Tip 2: 자주 쓰는 품목 반복

```
같은 품목을 3회 이상 선택하면:
  - confidence 0.7 도달
  - 자동 확정 확률 높아짐
  - 이후 입력이 매우 빨라짐!
```

### Tip 3: 다양한 표현 시도

```
발주 1: "lc 말보로"
발주 2: "레이크 찰리스 말보로"
발주 3: "lake chalice marlborough"

→ 다양한 표현이 모두 같은 품목으로 학습됨!
```

---

## 💾 학습 데이터 백업

### 자동 백업 (Git)

```bash
cd /home/user/webapp

# data.sqlite3는 .gitignore에 포함되어야 함
# 하지만 백업은 별도로 필요!

# 수동 백업
cp data.sqlite3 data.sqlite3.backup_$(date +%Y%m%d)

# 또는 ProjectBackup 도구 사용
```

---

## 🎓 학습 효과 실시간 체험

### Before (학습 0건)

```
입력: "ch 샤도네"
검색: 100개 후보 (샤르도네 전체)
정답 순위: 20위권
점수: 0.45
→ 수동 선택 필요
```

### After 1회 학습

```
입력: "ch 샤도네"
확장: "찰스하이직 샤르도네"
검색: 5개 후보
정답 순위: 1위
점수: 0.85
→ 거의 확정
```

### After 3회 학습

```
입력: "ch 샤도"
확장: "찰스하이직 샤르도네"
검색: 2개 후보
정답 순위: 압도적 1위
점수: 1.20
→ 자동 확정! 클릭만 하면 끝!
```

---

## 🎯 요약

### 당신이 할 일:
1. **발주 입력** (평소처럼)
2. **품목 선택** (후보 중 선택)
3. **확정 클릭** (끝!)

### 시스템이 자동으로:
1. ✅ 약어 매핑 감지 및 저장
2. ✅ ML 학습 데이터 수집
3. ✅ 신뢰도 점진적 증가
4. ✅ 검색 정확도 자동 향상

### 목표:
- **Week 1-2**: 50-100건 수집
- **Week 3-4**: 300-500건 수집
- **Month 2**: PyTorch 활성화 준비 완료!

---

**지금 바로 사용하시면 자동으로 학습됩니다!** 🚀

테스트 URL: https://3000-ihrunfcj6wdldlndzi6r8-d0b9e1e2.sandbox.novita.ai/wine
