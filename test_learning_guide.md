# 학습 시스템 테스트 가이드

## 📋 **테스트 시나리오**

### **시나리오 1: 품목 별칭 학습**
**목적**: 약어나 별칭을 학습시켜 다음부터 자동 인식되는지 확인

**단계:**
1. Wine Order 페이지 접속
2. 거래처 입력: `레이크 찰리스` (학습된 거래처)
3. 발주 내용: `lc 말보로 24병` (약어 사용)
4. 생성 클릭 → 후보 목록 확인
5. 올바른 품목 선택 후 **"학습" 버튼 클릭**
6. **다시 테스트**: `lc 말보로 24병` 입력
7. **기대 결과**: 학습한 품목이 **자동 확정** (score 1.0)

---

### **시나리오 2: 검색 학습 보너스**
**목적**: 자주 선택한 품목이 상위 노출되는지 확인

**단계:**
1. 비슷한 이름의 품목이 여러 개 있는 경우
2. 특정 품목을 3번 이상 선택하고 **학습 저장**
3. **다시 검색**: 같은 키워드 입력
4. **기대 결과**: 자주 선택한 품목의 점수가 **+0.10 ~ +0.35 상승**

---

### **시나리오 3: 신규 품목 학습**
**목적**: 신규 품목을 학습시켜 다음부터 기존 품목처럼 인식되는지 확인

**단계:**
1. 신규 품목 후보 선택 (is_new_item 배지 있음)
2. **공급가 입력** (필수)
3. **학습 버튼 클릭**
4. **API 호출**: `/api/learn-new-item`
5. **기대 결과**: 
   - 신규 품목이 `master` 시트에 추가됨
   - 다음 검색부터 기존 품목으로 인식됨

---

## 🔍 **학습 상태 확인 방법**

### **1. D1 데이터베이스 확인**
```bash
# item_alias 테이블 확인
npm run db:console:local
> SELECT * FROM item_alias ORDER BY last_used_at DESC LIMIT 10;

# search_learning 테이블 확인
> SELECT * FROM search_learning ORDER BY hit_count DESC LIMIT 10;
```

### **2. 로그 확인**
```bash
pm2 logs order-ai --nostream --lines 50 | grep -E '(학습|learned|alias)'
```

---

## ⚠️ **주의 사항**

1. **학습 저장 조건**:
   - 별칭(alias)과 정식 품목번호(canonical) 모두 필요
   - 신규 품목은 공급가(supplyPrice) 필수

2. **학습 우선순위**:
   - `exact` > `contains_specific` > `contains_weak`
   - `exact`, `contains_specific`는 즉시 확정 (score 1.0)

3. **검색 학습 보너스**:
   - 정규화된 검색어 길이가 6자 이상이어야 적용
   - 최대 보너스: +0.35

---

## 🐛 **디버깅 팁**

### **학습이 적용되지 않는 경우:**
1. **정규화 확인**: 
   - 입력값과 저장된 별칭의 정규화 결과가 동일한지 확인
   - 공백, 특수문자, 수량 제거 후 비교

2. **테이블 확인**:
   ```bash
   npm run db:console:local
   > SELECT * FROM item_alias WHERE alias LIKE '%lc%';
   ```

3. **로그 확인**:
   ```bash
   pm2 logs order-ai --nostream | grep 'getLearnedMatch'
   ```

---

## ✅ **성공 기준**

- [ ] 약어 학습 후 자동 확정 (score 1.0)
- [ ] 자주 선택한 품목의 점수 상승 (+0.10 ~ +0.35)
- [ ] 신규 품목 학습 후 기존 품목으로 인식
- [ ] 학습 데이터가 D1 데이터베이스에 저장됨
- [ ] 학습 UI에서 저장 완료 메시지 표시
