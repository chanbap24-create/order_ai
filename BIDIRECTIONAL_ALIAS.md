# 🔄 양방향 별칭 확장 시스템

## 📋 목차
- [문제점](#문제점)
- [해결 방법](#해결-방법)
- [작동 방식](#작동-방식)
- [실제 예시](#실제-예시)
- [기대 효과](#기대-효과)

---

## ❌ 문제점

### 기존 시스템의 한계

입고 데이터에 **약어로 저장**된 경우, 사용자가 정식명칭을 입력하면 검색 실패!

```
📦 입고 데이터:
  - VG 포마르 비에유 비뉴 2021
  - CL 샤블리 "샹트 메흘르" 2022
  - RO 시라즈 2023

👤 사용자 입력: "뱅상 지라르댕 포마르"
❌ 검색 결과: 없음

이유: 
  - 입고 데이터 = "VG 포마르..."
  - 검색어 = "뱅상 지라르댕 포마르"
  - 매칭 불가!
```

---

## ✅ 해결 방법

### 양방향 별칭 확장

**정방향 + 역방향 동시 적용!**

```typescript
// 정방향: 약어 → 정식명칭
"vg 포마르" 
  → "뱅상 지라르댕 포마르"

// 역방향: 정식명칭 → 약어 추가
"뱅상 지라르댕 포마르" 
  → "뱅상 지라르댕 포마르 vg"  ✅ vg도 검색!
```

---

## 🔍 작동 방식

### 1️⃣ 별칭 캐시 로드 (양방향)

```typescript
// 정방향 캐시
Map {
  'vg' => '뱅상 지라르댕',
  'cl' => '클레멍 라발리',
  'ro' => '로버트 오틀리',
  'ch' => '찰스 하이직',
  'bs' => '비온디 산티'
}

// 역방향 캐시 (NEW!)
Map {
  '뱅상 지라르댕' => ['vg'],
  '클레멍 라발리' => ['cl'],
  '로버트 오틀리' => ['ro'],
  '찰스 하이직' => ['ch'],
  '비온디 산티' => ['bs']
}
```

### 2️⃣ 확장 프로세스

```
입력: "뱅상 지라르댕 포마르"

┌─────────────────────────────────────┐
│ 1️⃣ 정방향 매칭 (alias → canonical) │
│    매칭 없음                         │
│    결과: "뱅상 지라르댕 포마르"      │
└────────────┬────────────────────────┘
             ↓
┌─────────────────────────────────────┐
│ 2️⃣ 역방향 매칭 (canonical → alias) │
│    "뱅상 지라르댕" 발견!             │
│    약어 추가: +vg                    │
│    결과: "뱅상 지라르댕 포마르 vg"   │
└────────────┬────────────────────────┘
             ↓
┌─────────────────────────────────────┐
│ 3️⃣ 품목 검색                        │
│    검색어 1: "뱅상 지라르댕 포마르"  │
│    검색어 2: "vg 포마르"             │
│    ✅ 둘 다 검색!                    │
└─────────────────────────────────────┘
```

---

## 📊 실제 예시

### 예시 1: 약어 입력 (기존과 동일)

```typescript
입력: "vg 포마르 6"

1️⃣ 정방향: "vg" → "뱅상 지라르댕"
   결과: "뱅상 지라르댕 포마르 6"

2️⃣ 역방향: "뱅상 지라르댕" 발견 → +vg
   결과: "뱅상 지라르댕 포마르 6 vg"

✅ 최종 검색어: "뱅상 지라르댕 포마르 6 vg"
   → 정식명칭 + 약어 모두 검색!
```

### 예시 2: 정식명칭 입력 (NEW! 🎉)

```typescript
입력: "뱅상 지라르댕 포마르"

1️⃣ 정방향: 매칭 없음
   결과: "뱅상 지라르댕 포마르"

2️⃣ 역방향: "뱅상 지라르댕" 발견 → +vg ✅
   결과: "뱅상 지라르댕 포마르 vg"

✅ 최종 검색어: "뱅상 지라르댕 포마르 vg"
   → 입고 데이터 "VG 포마르..."도 검색됨!
```

### 예시 3: 여러 별칭 동시 적용

```typescript
입력: "클레멍 라발리 샤블리 뱅상 지라르댕 포마르"

1️⃣ 정방향: 매칭 없음

2️⃣ 역방향: 
   - "클레멍 라발리" → +cl
   - "뱅상 지라르댕" → +vg

✅ 최종: "클레멍 라발리 샤블리 뱅상 지라르댕 포마르 cl vg"
   → 두 약어 모두 추가!
```

---

## 🎯 기대 효과

### 1️⃣ 검색 성공률 대폭 향상

| 입고 데이터 형식 | 사용자 입력 | 기존 시스템 | 새 시스템 |
|-----------------|------------|------------|-----------|
| VG 포마르 2021 | vg 포마르 | ✅ 성공 | ✅ 성공 |
| VG 포마르 2021 | 뱅상 지라르댕 포마르 | ❌ 실패 | ✅ 성공 |
| 뱅상 지라르댕 포마르 2021 | vg 포마르 | ✅ 성공 | ✅ 성공 |
| 뱅상 지라르댕 포마르 2021 | 뱅상 지라르댕 포마르 | ✅ 성공 | ✅ 성공 |

### 2️⃣ 사용자 편의성 향상

```
사용자는 어떤 방식으로 입력해도 OK!

✅ 약어: "vg 포마르"
✅ 정식명칭: "뱅상 지라르댕 포마르"
✅ 혼합: "vg 샤블리 cl 브르고뉴"

모두 정상 검색!
```

### 3️⃣ 데이터 형식 무관

```
입고 데이터가 어떤 형식이든 상관없음!

📦 약어 형식:
  - VG 포마르 2021
  - CL 샤블리 2022

📦 정식명칭 형식:
  - 뱅상 지라르댕 포마르 2021
  - 클레멍 라발리 샤블리 2022

📦 혼합 형식:
  - VG 포마르 2021
  - 클레멍 라발리 샤블리 2022

모두 검색 가능!
```

---

## 🔧 구현 상세

### 파일 위치

```
app/lib/naturalLanguagePreprocessor.ts
```

### 핵심 함수

#### 1. `loadAliasCache()` - 양방향 캐시 로드

```typescript
function loadAliasCache(): { 
  forward: Map<string, string>; 
  reverse: Map<string, string[]> 
} {
  // 정방향: alias → canonical
  const forward = new Map();
  
  // 역방향: canonical → [alias1, alias2, ...]
  const reverse = new Map();
  
  return { forward, reverse };
}
```

#### 2. `expandAliases()` - 양방향 확장

```typescript
export function expandAliases(text: string): string {
  const { forward, reverse } = loadAliasCache();
  
  // 1. 정방향: 약어 → 정식명칭
  // "vg" → "뱅상 지라르댕"
  
  // 2. 역방향: 정식명칭 → 약어 추가
  // "뱅상 지라르댕" → +vg
  
  return expanded;
}
```

---

## 📈 성능 영향

### 캐시 사용으로 성능 최적화

```typescript
// 캐시 TTL: 1분
const CACHE_TTL = 60000;

// 1분마다 자동 갱신
// 1분 내에는 메모리 캐시 재사용
// → 성능 저하 거의 없음!
```

### 추가 처리 시간

- 정방향 매칭: 기존과 동일 (0ms)
- 역방향 매칭: 약 1-2ms 추가
- **전체 영향**: 무시할 수 있는 수준

---

## 🧪 테스트 방법

### 1. Wine 페이지에서 테스트

```
https://order-ai-one.vercel.app/wine

테스트 입력:
1. "vg 포마르" → ✅ 정상 검색
2. "뱅상 지라르댕 포마르" → ✅ 정상 검색 (NEW!)
3. "cl 샤블리" → ✅ 정상 검색
4. "클레멍 라발리 샤블리" → ✅ 정상 검색 (NEW!)
```

### 2. 디버그 API

```bash
# 별칭 확장 확인
curl "https://order-ai-one.vercel.app/api/debug-alias?q=뱅상 지라르댕 포마르"

# 응답 예시
{
  "success": true,
  "query": "뱅상 지라르댕 포마르",
  "expanded": "뱅상 지라르댕 포마르 vg",
  "stats": {
    "forwardMatches": 0,
    "reverseMatches": 1
  }
}
```

### 3. 로컬 테스트 스크립트

```bash
# 양방향 별칭 확장 테스트
node test_bidirectional_alias.js
```

---

## 📝 요약

| 항목 | 설명 |
|------|------|
| **목적** | 입고 데이터가 약어로 저장되어도 검색 가능 |
| **방식** | 정방향 + 역방향 동시 확장 |
| **효과** | 검색 성공률 대폭 향상 |
| **성능** | 캐시 사용으로 성능 영향 최소 |
| **사용자** | 약어/정식명칭 어떤 방식이든 OK |

---

## 🚀 배포 상태

- ✅ 커밋: `6cede37` - 양방향 별칭 확장 시스템 추가
- ✅ 푸시: origin/main 완료
- 🔄 Vercel 자동 배포 중
- 🌐 배포 URL: https://order-ai-one.vercel.app

---

**업데이트 완료 시각**: 2026-01-16  
**커밋**: [6cede37](https://github.com/chanbap24-create/order_ai/commit/6cede37)
